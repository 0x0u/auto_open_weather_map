import os
import requests
import textwrap
from datetime import datetime, timedelta, timezone

pre_ids = {
    "åŒ—æµ·é“": 2130037,
    "é’æ£®çœŒ": 2130658,
    "å²©æ‰‹çœŒ": 2112518,
    "å®®åŸçœŒ": 2111888,
    "ç§‹ç”°çœŒ": 2113126,
    "å±±å½¢çœŒ": 2110556,
    "ç¦å³¶çœŒ": 2112923,
    "èŒ¨åŸçœŒ": 1862033,
    "æ ƒæœ¨çœŒ": 1850311,
    "ç¾¤é¦¬çœŒ": 1863501,
    "åŸ¼ç‰çœŒ": 6940394,
    "åƒè‘‰çœŒ": 2113015,
    "æ±äº¬éƒ½": 1850147,
    "ç¥å¥ˆå·çœŒ": 1860291,
    "æ–°æ½ŸçœŒ": 1855431,
    "å¯Œå±±çœŒ": 1849876,
    "çŸ³å·çœŒ": 1861393,
    "ç¦äº•çœŒ": 1863983,
    "å±±æ¢¨çœŒ": 1848649,
    "é•·é‡çœŒ": 1856215,
    "å²é˜œçœŒ": 1863640,
    "é™å²¡çœŒ": 1851717,
    "æ„›çŸ¥çœŒ": 1865694,
    "ä¸‰é‡çœŒ": 1857357,
    "æ»‹è³€çœŒ": 1852553,
    "äº¬éƒ½åºœ": 1857910,
    "å¤§é˜ªåºœ": 1853908,
    "å…µåº«çœŒ": 1862047,
    "å¥ˆè‰¯çœŒ": 1855612,
    "å’Œæ­Œå±±çœŒ": 1926004,
    "é³¥å–çœŒ": 1849890,
    "å³¶æ ¹çœŒ": 1852442,
    "å²¡å±±çœŒ": 1854383,
    "åºƒå³¶çœŒ": 1862415,
    "å±±å£çœŒ": 1848689,
    "å¾³å³¶çœŒ": 1850158,
    "é¦™å·çœŒ": 1860834,
    "æ„›åª›çœŒ": 1864226,
    "é«˜çŸ¥çœŒ": 1859146,
    "ç¦å²¡çœŒ": 1863967,
    "ä½è³€çœŒ": 1853303,
    "é•·å´çœŒ": 1856177,
    "ç†Šæœ¬çœŒ": 1858421,
    "å¤§åˆ†çœŒ": 1854487,
    "å®®å´çœŒ": 1856717,
    "é¹¿å…å³¶çœŒ": 1860827,
    "æ²–ç¸„çœŒ": 1894616
}

icons = {
    200: "âš¡",
    201: "âš¡",
    202: "âš¡",
    210: "âš¡",
    211: "âš¡",
    212: "âš¡",
    221: "âš¡",
    230: "âš¡",
    231: "âš¡",
    232: "âš¡",
    300: "ğŸŒ§",
    301: "ğŸŒ§",
    302: "ğŸŒ§",
    310: "ğŸŒ§",
    311: "ğŸŒ§",
    312: "ğŸŒ§",
    313: "ğŸŒ§",
    314: "ğŸŒ§",
    321: "ğŸŒ§",
    500: "ğŸŒ¦",
    501: "ğŸŒ¦",
    502: "ğŸŒ¦",
    503: "ğŸŒ¦",
    504: "ğŸŒ¦",
    511: "â„ï¸",
    520: "ğŸŒ§",
    521: "ğŸŒ§",
    522: "ğŸŒ§",
    531: "ğŸŒ§",
    600: "â„ï¸",
    601: "â„ï¸",
    602: "â„ï¸",
    611: "â„ï¸",
    612: "â„ï¸",
    613: "â„ï¸",
    615: "â„ï¸",
    616: "â„ï¸",
    620: "â„ï¸",
    621: "â„ï¸",
    622: "â„ï¸",
    701: "ğŸŒ«",
    711: "ğŸŒ«",
    721: "ğŸŒ«",
    731: "ğŸŒ«",
    741: "ğŸŒ«",
    751: "ğŸŒ«",
    761: "ğŸŒ«",
    771: "ğŸŒ«",
    781: "ğŸŒ«",
    800: "â˜€ï¸",
    801: "ğŸŒ¤",
    802: "â›…ï¸",
    803: "â˜ï¸",
    804: "â˜ï¸"

}


def get_weather_data(name, pre_id):
    url = "http://api.openweathermap.org/data/2.5/weather"
    query = {
        "APPID": os.environ.get("APPID"),
        "units": "metric",
        "id": pre_id,
        "mode": "json"
    }
    r = requests.get(url, params=query)
    data = r.json()
    print(data)
    weather = icons[data["weather"][0]["id"]]
    description = data["weather"][0]["description"]
    humidity = data["main"]["humidity"]
    temp_max = data["main"]["temp_max"]
    temp_min = data["main"]["temp_min"]
    return "|{}|{}|{}|{}|{}|{}|".format(name, weather, description, humidity, temp_max, temp_min)


if __name__ == "__main__":
    jst = timezone(timedelta(hours=+9), "JST")
    today = datetime.now(jst).strftime("%Y-%m-%d")

    md = textwrap.dedent("""
        ![workflow](https://github.com/0x0u/auto_open_weather_map/workflows/workflow/badge.svg?branch=master)
        ## Auto Open Weather Map
        update: {}
        
        |prefectures|weather|description|humidity(%)|temp_max(â„ƒ)|temp_min(â„ƒ)|
        |:-----------:|:------------:|:------------:|:-----------:|:------------:|:-----------:|
    """).format(today).strip() + "\n"

    for i in pre_ids:
        data = get_weather_data(i, pre_ids[i])
        md += data + "\n"

    with open("README.md", "w") as f:
        f.write(md)
